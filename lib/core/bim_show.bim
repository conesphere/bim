#!/bin/bash

# bim_show "menuname" 
# shows a select menu for bim on the screen 
# it tries to get some globally defined hashes and arrays 
# defining the menu options, and prints that menu, together 
# with some extra opts back to the user. 
bim_show() {
	MENUSTR=$(declare -p "${1}_entry" 2> /dev/null || echo "()")
	TOPICSTR=$(declare -p "${1}_topic" 2> /dev/null || echo "()")
	ENABLESTR=$(declare -p "${1}_enable" 2> /dev/null || echo "()")
	REPLYSTR=$(declare -p "${1}_reply" 2> /dev/null || echo "()")
	REPLYHELPSTR=$(declare -p "${1}_reply_help" 2> /dev/null || echo "()")
	shift
	PS3="
selection (? for help) ---> "
	declare -A MENUDICT=${MENUSTR#*=}
	declare -a TOPIC=${TOPICSTR#*=}
	declare -A ENABLE=${ENABLESTR#*=}
	declare -A REPLYDICT=${REPLYSTR#*=}
	declare -A REPLYHELP=${REPLYHELPSTR#*=}

	declare -a MENUKEYS=()
	declare -a MENUSORTED=()
	declare -A MENU=()
	
	IFS=$'\n' MENUSORTED=($(sort <<<"${!MENUDICT[*]}"))
	unset IFS	

	for entry in "${MENUSORTED[@]}"
	do
		if [[ -n "${ENABLE[${entry#_*_ }]}" ]]
		then 
			if "${ENABLE[${entry#_*_ }]}"
			then
				# good entry is enabled 
				echo -n 
			else
				continue
			fi
		fi
		MENUKEYS+=("${entry#_*_ }")
		MENU["${entry#_*_ }"]="${MENUDICT[${entry}]}"
	done

	# configure reply defaults (only ? is hardcoded)
	REPLYDICT["q"]="exit"
	REPLYDICT["r"]="break"

	# configure default help text for q r and ? 
	REPLYHELP["r"]="Leave this Menu (return)"
	REPLYHELP["q"]="Leave the Program (quit)"
	REPLYHELP["?"]="This Help"

	if [[ -n "${TOPIC}" ]]
	then
		echo 
		echo "${TOPIC[@]}"
	fi
	echo
	select item in "${MENUKEYS[@]}"
	do
		if [[ -z "${item}" ]] 
		then
			# get all args except for the reply cmd 
			AREPLY=(${REPLY})
			REPLY="${AREPLY[0]}"
			ARGS="${AREPLY[@]:1}"
			if [[ -n ${REPLYDICT["${REPLY}"]} ]]
			then
				if [[ -z "${ARGS}" ]]
				then
					${REPLYDICT["${REPLY}"]} || echo "reply command failed, returncode $?"
				else
					${REPLYDICT["${REPLY}"]} "${ARGS[@]}" || echo "reply command failed, returncode $?"
				fi
			fi
			# print the help here
			if [[ "${REPLY}" = "?" ]]
			then
				echo ""
				echo "This is Help for Menu:    ${TOPIC[@]}"
				echo ""
				echo "You might also use the following commands:"
				echo ""
				for opt in "${!REPLYHELP[@]}"
				do
					echo "${opt}	${REPLYHELP[${opt}]}"
				done
			fi
		else
			if [[ -n ${MENU["${item}"]} ]]
			then 
				if [[ -z "${@}" ]]
				then
					${MENU["${item}"]} || echo "menu command failed, returncode $?"
				else
					${MENU["${item}"]} "${@}"|| echo "menu command failed, returncode $?"
				fi
			fi
		fi
	done
}

